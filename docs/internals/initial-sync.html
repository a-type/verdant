<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-internals/initial-sync">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Initial sync | Verdant</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://verdant.dev/docs/internals/initial-sync"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="twitter:title" content="verdant"><meta data-rh="true" name="twitter:description" content="a framework for small, sustainable, human apps"><meta data-rh="true" name="twitter:image" content="https://verdant.dev/opengraph.png"><meta data-rh="true" name="og:image" content="https://verdant.dev/opengraph.png"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Initial sync | Verdant"><meta data-rh="true" name="description" content="When a replica comes online, it must exchange information with the server until they share a common understanding of the operation history of the library in question."><meta data-rh="true" property="og:description" content="When a replica comes online, it must exchange information with the server until they share a common understanding of the operation history of the library in question."><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://verdant.dev/docs/internals/initial-sync"><link data-rh="true" rel="alternate" href="https://verdant.dev/docs/internals/initial-sync" hreflang="en"><link data-rh="true" rel="alternate" href="https://verdant.dev/docs/internals/initial-sync" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Verdant RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Verdant Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ee0d08be.css">
<link rel="preload" href="/assets/js/runtime~main.40b94839.js" as="script">
<link rel="preload" href="/assets/js/main.45e13d48.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_Wy77">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/favicon-32x32.png" alt="Verdant logo" class="themedImage_YoYt themedImage--light_io7T"><img src="/favicon-32x32.png" alt="Verdant logo" class="themedImage_YoYt themedImage--dark_x6Fh"></div><b class="navbar__title text--truncate">Verdant</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/a-type/verdant" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pvEX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_aaQS colorModeToggle_zzH1"><button class="clean-btn toggleButton_aMEy toggleButtonDisabled_GHHW" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_ywfS"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_JtjS"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox__mRI"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_OiwQ docsWrapper_JQfB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_o_vs" type="button"></button><div class="docPage_i_cg"><aside class="theme-doc-sidebar-container docSidebarContainer_W3CP"><div class="sidebar_zkUS"><nav class="menu thin-scrollbar menu_tdVB"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Intro to Verdant</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/manifesto">The Verdant manifesto on sustainable software</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/storing--querying">Storing &amp; Querying</a><button aria-label="Toggle the collapsible sidebar category &#x27;Storing &amp; Querying&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/sync">Sync</a><button aria-label="Toggle the collapsible sidebar category &#x27;Sync&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/react">React</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cli">CLI</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/how-it-works">How it works</a><button aria-label="Toggle the collapsible sidebar category &#x27;How it works&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/internals/initial-sync">Initial sync</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/internals/assumptions">Protocol assumptions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/internals/entity-ids">Entity IDs</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/react-router">React Router</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/comparisons">Comparisons to other local-first tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/efficiency">Efficiency &amp; Performance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_n2Kr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_qTeG"><div class="docItemContainer_NWgK"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_SdBV" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_GEeg"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/how-it-works"><span itemprop="name">How it works</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Initial sync</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_FZzE theme-doc-toc-mobile tocMobile_Waqm"><button type="button" class="clean-btn tocCollapsibleButton_XliJ">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Initial sync</h1><p>When a replica comes online, it must exchange information with the server until they share a common understanding of the operation history of the library in question.</p><p>A naive approach would be to have the replica send over any changes it made since the last time it saw the server, and for the server to respond with any changes it received in the same time interval. And this, in fact, gets us very far.</p><p>However, there are a few contingencies to consider which require more robust protocols. In fact I&#x27;m writing this document to define and explore those before implementing said protocols, as a thought exercise.</p><h2 class="anchor anchorWithStickyNavbar_SsL4" id="a-replica-is-not-the-first-to-initialize-a-new-library">A replica is not the first to initialize a new library<a class="hash-link" href="#a-replica-is-not-the-first-to-initialize-a-new-library" title="Direct link to heading">​</a></h2><p>Suppose replicas A and B are both attempting to sync, for the first time, to a brand new Library 1. A gets there first, so the server receives and copies A&#x27;s local history into its own database.</p><p>When B arrives, what should happen? B and A have entirely separate and theoretically irreconcilable histories. We could <em>attempt</em> to merge them, but Verdant&#x27;s assumption is that this could cause more harm than good.</p><p>Instead, the server will ignore B&#x27;s incoming data and respond with its full storage, instructing B to reset its local state instead.</p><p>This means that if you write an app which optimistically chooses a library ID and tries to push local data to that library, it may end up with all your local data being lost!</p><p>Instead, joining a library should be a very explicit action that the user consents to, and your app should be designed such that the only the first user to be given access to a library is under the assumption their data will be utilized. Subsequent joiners should be informed that their local changes will be lost.</p><h2 class="anchor anchorWithStickyNavbar_SsL4" id="a-replica-goes-truant-and-then-reconnects">A replica goes &quot;truant&quot; and then reconnects<a class="hash-link" href="#a-replica-goes-truant-and-then-reconnects" title="Direct link to heading">​</a></h2><p>This is actually the same as the previous case! A replica used to be part of a library but hasn&#x27;t been seen in so long that the server has kicked it out. When it reconnects, local changes are forfeit.</p><h2 class="anchor anchorWithStickyNavbar_SsL4" id="a-replica-has-lost-its-local-data-store">A replica has lost its local data store<a class="hash-link" href="#a-replica-has-lost-its-local-data-store" title="Direct link to heading">​</a></h2><p>In theory, we&#x27;d see this crop up if the user cleared site data - like, the server would think it&#x27;s seen the replica before, and only catch it up on recent changes, leading to incomplete history.</p><p>However, it doesn&#x27;t actually happen, because the replica ID is also stored alongside operations and baselines. So when a user clears the storage, the replica reconnects as a new identity, and receives the full history in return.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/how-it-works"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">How it works</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/internals/assumptions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Protocol assumptions</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a3z4 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#a-replica-is-not-the-first-to-initialize-a-new-library" class="table-of-contents__link toc-highlight">A replica is not the first to initialize a new library</a></li><li><a href="#a-replica-goes-truant-and-then-reconnects" class="table-of-contents__link toc-highlight">A replica goes &quot;truant&quot; and then reconnects</a></li><li><a href="#a-replica-has-lost-its-local-data-store" class="table-of-contents__link toc-highlight">A replica has lost its local data store</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/a-type/verdant/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pvEX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/V9NzJrYVKU" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pvEX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/a-type/verdant" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_pvEX"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gfor.rest" target="_blank" rel="noopener noreferrer" class="footer__link-item">Grant</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Grant Forrest. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.40b94839.js"></script>
<script src="/assets/js/main.45e13d48.js"></script>
</body>
</html>