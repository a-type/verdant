"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1093],{2298:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"local-storage/export","title":"Exporting and importing data","description":"Verdant clients can export all local data, and even download remote files if needed to include in the export.","source":"@site/docs/local-storage/export.md","sourceDirName":"local-storage","slug":"/local-storage/export","permalink":"/docs/local-storage/export","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"File storage","permalink":"/docs/local-storage/files"},"next":{"title":"Sync","permalink":"/docs/category/sync"}}');var i=n(1273),a=n(8576);const s={sidebar_position:8},r="Exporting and importing data",l={},d=[{value:"Uses of exporting data",id:"uses-of-exporting-data",level:2},{value:"Using exports to transfer data between origins",id:"using-exports-to-transfer-data-between-origins",level:2},{value:"How the transfer works",id:"how-the-transfer-works",level:3},{value:"Limitations of exporting data",id:"limitations-of-exporting-data",level:2}];function c(e){const t={blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"exporting-and-importing-data",children:"Exporting and importing data"})}),"\n",(0,i.jsx)(t.p,{children:"Verdant clients can export all local data, and even download remote files if needed to include in the export."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"const exportedData = await client.export({ downloadRemoteFiles: true });\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This exported data includes all document data, even change history. It also includes metadata about files, and the files themselves (as a list of ",(0,i.jsx)(t.code,{children:"File"}),"s)."]}),"\n",(0,i.jsxs)(t.p,{children:["This means a client importing this dataset should behave identically to the client which exported it. The only caveat is that importing doesn't take on the original client's ",(0,i.jsx)(t.em,{children:"sync identity"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"uses-of-exporting-data",children:"Uses of exporting data"}),"\n",(0,i.jsx)(t.p,{children:"Since local-first apps are tied to a domain for their local storage, exporting can allow you to transfer data if your app moves to a new domain. I don't recommend moving domains if you can help it. See how to do this relatively seamlessly below."}),"\n",(0,i.jsx)(t.h2,{id:"using-exports-to-transfer-data-between-origins",children:"Using exports to transfer data between origins"}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["First off, ",(0,i.jsx)(t.strong,{children:"if your users are using sync, you don't need to do this"})," - you can instead use the sync server to transfer data by moving users' sync endpoint over to the new server before completing the domain migration. A replica will populate the new sync server automatically and then you're ready to transition."]}),"\n"]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["Also, ",(0,i.jsx)(t.strong,{children:"on iOS, this doesn't work in a PWA"}),". Apple restricts the storage context of PWAs on iPhones, so although the transfer itself will work, the new origin won't have access to the data when launched in Safari or installed as a new PWA. Aren't iPhones fun?"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Verdant has built-in tools to easily transfer a library from one origin (website) to another built on top of the ",(0,i.jsx)(t.code,{children:"export"})," functionality documented above. This is an experimental tool which uses an embedded ",(0,i.jsx)(t.code,{children:"iframe"})," to transmit the data file directly through the browser - no server required!"]}),"\n",(0,i.jsx)(t.p,{children:"First off, it's important that both sites are running the exact same codebase. To make the transition, point DNS records for both origins to the same hosted webpage. Any discrepancy in schemas will cause unworkable errors."}),"\n",(0,i.jsx)(t.p,{children:"Then, add the following code snippet anywhere in your app:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"// assuming you have a ClientDescriptor instance handy here. You probably\n// already have a client ready somewhere!\nconst client = await clientDescriptor.open();\n\nconst backup = await('@verdant-web/store/backup');\nbackup.transferOrigins(\n\tclient,\n\t'https://OLD-origin.com',\n\t'https://NEW-origin.com',\n);\n"})}),"\n",(0,i.jsx)(t.p,{children:"That's the bulk of it! Since this code runs on both the new and old origins, the helper will synchronize the back-and-forth transfer negotiation for you from both sides."}),"\n",(0,i.jsxs)(t.p,{children:["The last thing you need to do to make this work is add a ",(0,i.jsx)(t.code,{children:"?transfer=true"})," query param to your NEW origin. This will initiate the transfer helper."]}),"\n",(0,i.jsxs)(t.p,{children:["The most straightforward pattern here is to show a modal or something to the user explaining the domain move, and then give them a link to the new origin with ",(0,i.jsx)(t.code,{children:"?transfer=true"})," set. But if you don't want to explain anything, I guess you could just set up a redirect."]}),"\n",(0,i.jsx)(t.p,{children:"And, again, this doesn't work on iPhone PWAs. If your old app was an iPhone PWA... you have to instruct your user to export their data and import it after installing the new app \ud83d\ude1e."}),"\n",(0,i.jsx)(t.h3,{id:"how-the-transfer-works",children:"How the transfer works"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["New app detects it's on the new origin and the ",(0,i.jsx)(t.code,{children:"?transfer=true"})," param is set."]}),"\n",(0,i.jsxs)(t.li,{children:["New app creates an ",(0,i.jsx)(t.code,{children:"iframe"})," for the old origin."]}),"\n",(0,i.jsxs)(t.li,{children:["The ",(0,i.jsx)(t.code,{children:"iframe"})," detects it's on the old origin and sends out a message to any parent window on the new origin that it's ready to transfer."]}),"\n",(0,i.jsx)(t.li,{children:"New app detects the message and responds with a go-ahead."}),"\n",(0,i.jsxs)(t.li,{children:["The ",(0,i.jsx)(t.code,{children:"iframe"})," does a client export and sends the data as an attachment in a post message."]}),"\n",(0,i.jsx)(t.li,{children:"The new app receives the export file, unbundles it, and loads it up. Then it deletes the query param."}),"\n",(0,i.jsx)(t.li,{children:"Just in case (to avoid accidental resets), a local storage flag is also set to avoid another transfer in the future."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"limitations-of-exporting-data",children:"Limitations of exporting data"}),"\n",(0,i.jsx)(t.p,{children:"At the time of writing, exported data can only be imported again if the client's schema matches the schema of the export exactly. That means you can't import data from old versions."}),"\n",(0,i.jsx)(t.p,{children:'This is a significant limitation which basically removes this data export as a reliable "backup" option for users. It relegates it to temporary operations, like transferring between domains, or simple data "take-away" for users who want to, say, download all their files.'}),"\n",(0,i.jsx)(t.p,{children:"It's theoretically possible for me to support older versions, but I'm launching this as-is for now."})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8576:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>r});var o=n(3917);const i={},a=o.createContext(i);function s(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(a.Provider,{value:t},e.children)}}}]);